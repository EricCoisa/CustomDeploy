# üèóÔ∏è Script de Teste - Campo ParentProject

## Funcionalidade Implementada
Campo `parentProject` que detecta automaticamente se um deploy faz parte de um projeto pai maior, baseado na estrutura da `targetPath`.

## L√≥gica Implementada
- **Se `targetPath` cont√©m `/`**: ParentProject = primeira parte do caminho
  - Ex: `app2/api` ‚Üí ParentProject = `"app2"`
  - Ex: `microservices/auth/api` ‚Üí ParentProject = `"microservices"`
- **Se `targetPath` n√£o cont√©m `/`**: ParentProject = `null`
  - Ex: `app1` ‚Üí ParentProject = `null`

## üîê 1. Obter Token de Autentica√ß√£o

```powershell
# Login para obter token JWT
$loginBody = @{
    username = "admin"
    password = "password"
} | ConvertTo-Json

$loginResponse = Invoke-RestMethod -Uri "https://localhost:7071/auth/login" -Method POST -Body $loginBody -ContentType "application/json"
$token = $loginResponse.token

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

Write-Host "‚úÖ Token obtido com sucesso"
```

## üöÄ 2. Criar Deploys de Teste

```powershell
Write-Host "üöÄ Criando deploys de teste para validar parentProject..."

# Array de deploys de teste com diferentes estruturas
$testDeploys = @(
    @{
        name = "app1-standalone"
        targetPath = "app1"
        expectedParent = $null
        description = "Deploy no n√≠vel raiz (sem parent)"
    },
    @{
        name = "app2-api"
        targetPath = "app2/api"
        expectedParent = "app2"
        description = "API dentro do projeto app2"
    },
    @{
        name = "app2-frontend"
        targetPath = "app2/frontend"
        expectedParent = "app2"
        description = "Frontend dentro do projeto app2"
    },
    @{
        name = "microservices-auth"
        targetPath = "microservices/auth"
        expectedParent = "microservices"
        description = "Servi√ßo de auth dentro de microservices"
    },
    @{
        name = "microservices-payment"
        targetPath = "microservices/payment"
        expectedParent = "microservices"
        description = "Servi√ßo de payment dentro de microservices"
    },
    @{
        name = "ecommerce-admin-panel"
        targetPath = "ecommerce/admin/panel"
        expectedParent = "ecommerce"
        description = "Painel admin com m√∫ltiplos n√≠veis"
    }
)

foreach ($deploy in $testDeploys) {
    Write-Host "üì¶ Criando deploy: $($deploy.name) - $($deploy.description)"
    
    $deployBody = @{
        repoUrl = "https://github.com/microsoft/vscode-website.git"
        branch = "main"
        buildCommand = "echo 'Build para teste parentProject'"
        buildOutput = "."
        targetPath = $deploy.targetPath
    } | ConvertTo-Json

    try {
        $deployResponse = Invoke-RestMethod -Uri "https://localhost:7071/deploy" -Method POST -Body $deployBody -Headers $headers
        
        if ($deployResponse.success) {
            Write-Host "  ‚úÖ Deploy criado: $($deploy.name)"
        } else {
            Write-Host "  ‚ùå Falha: $($deployResponse.message)"
        }
    } catch {
        Write-Host "  ‚ö†Ô∏è Erro: $($_.Exception.Message)"
    }
    
    # Aguardar um pouco entre deploys
    Start-Sleep -Seconds 2
}
```

## üìã 3. Testar Campo ParentProject

```powershell
Write-Host "üìã Testando campo parentProject na listagem de publica√ß√µes..."

try {
    $publicationsResponse = Invoke-RestMethod -Uri "https://localhost:7071/deploy/publications" -Method GET -Headers $headers
    
    Write-Host "‚úÖ Publica√ß√µes obtidas com sucesso: $($publicationsResponse.count) encontradas"
    Write-Host ""
    
    # Agrupar por parentProject para visualiza√ß√£o
    $withParent = $publicationsResponse.publications | Where-Object { $_.parentProject -ne $null }
    $withoutParent = $publicationsResponse.publications | Where-Object { $_.parentProject -eq $null }
    
    Write-Host "üèóÔ∏è DEPLOYS COM PROJETO PAI:"
    Write-Host "=" * 50
    
    if ($withParent.Count -gt 0) {
        $groupedByParent = $withParent | Group-Object -Property parentProject
        
        foreach ($group in $groupedByParent) {
            Write-Host "üìÅ Projeto Pai: $($group.Name)"
            foreach ($deploy in $group.Group) {
                Write-Host "  ‚îî‚îÄ‚îÄ $($deploy.name) (targetPath: $($deploy.fullPath -replace [regex]::Escape($publicationsPath), ''))"
                Write-Host "      Repository: $($deploy.repository)"
                Write-Host "      Exists: $($deploy.exists)"
                Write-Host "      Size: $($deploy.sizeMB) MB"
                Write-Host ""
            }
        }
    } else {
        Write-Host "‚ùå Nenhum deploy com projeto pai encontrado"
    }
    
    Write-Host "üè† DEPLOYS NO N√çVEL RAIZ (SEM PROJETO PAI):"
    Write-Host "=" * 50
    
    if ($withoutParent.Count -gt 0) {
        foreach ($deploy in $withoutParent) {
            Write-Host "üì¶ $($deploy.name)"
            Write-Host "   ParentProject: null"
            Write-Host "   Repository: $($deploy.repository)"
            Write-Host "   Exists: $($deploy.exists)"
            Write-Host "   Size: $($deploy.sizeMB) MB"
            Write-Host ""
        }
    } else {
        Write-Host "‚ùå Nenhum deploy no n√≠vel raiz encontrado"
    }
    
} catch {
    Write-Host "‚ùå Erro ao obter publica√ß√µes: $($_.Exception.Message)"
}
```

## üß™ 4. Validar Casos de Teste Espec√≠ficos

```powershell
Write-Host "üß™ Validando casos de teste espec√≠ficos..."

foreach ($deploy in $testDeploys) {
    Write-Host "üîç Validando: $($deploy.name)"
    
    try {
        $publication = $publicationsResponse.publications | Where-Object { 
            $_.name -eq $deploy.name -or $_.name -like "*$($deploy.name)*"
        }
        
        if ($publication) {
            $actualParent = $publication.parentProject
            $expectedParent = $deploy.expectedParent
            
            if (($actualParent -eq $null -and $expectedParent -eq $null) -or 
                ($actualParent -eq $expectedParent)) {
                Write-Host "  ‚úÖ PASSOU: ParentProject = '$actualParent' (esperado: '$expectedParent')"
            } else {
                Write-Host "  ‚ùå FALHOU: ParentProject = '$actualParent' (esperado: '$expectedParent')"
            }
            
            Write-Host "     TargetPath: $($deploy.targetPath)"
            Write-Host "     Description: $($deploy.description)"
        } else {
            Write-Host "  ‚ö†Ô∏è Deploy n√£o encontrado na listagem"
        }
    } catch {
        Write-Host "  ‚ùå Erro na valida√ß√£o: $($_.Exception.Message)"
    }
    
    Write-Host ""
}
```

## üìä 5. Estat√≠sticas de Projeto Pai

```powershell
Write-Host "üìä Estat√≠sticas de projetos pai..."

try {
    $allPublications = $publicationsResponse.publications
    
    # Calcular estat√≠sticas
    $totalDeploys = $allPublications.Count
    $deploysWithParent = ($allPublications | Where-Object { $_.parentProject -ne $null }).Count
    $deploysWithoutParent = $totalDeploys - $deploysWithParent
    
    # Contar projetos pai √∫nicos
    $uniqueParents = $allPublications | Where-Object { $_.parentProject -ne $null } | 
                     Select-Object -ExpandProperty parentProject -Unique
    
    Write-Host "üìà ESTAT√çSTICAS:"
    Write-Host "  Total de Deploys: $totalDeploys"
    Write-Host "  Deploys com Projeto Pai: $deploysWithParent"
    Write-Host "  Deploys no N√≠vel Raiz: $deploysWithoutParent"
    Write-Host "  Projetos Pai √önicos: $($uniqueParents.Count)"
    Write-Host ""
    
    if ($uniqueParents.Count -gt 0) {
        Write-Host "üèóÔ∏è PROJETOS PAI IDENTIFICADOS:"
        foreach ($parent in $uniqueParents) {
            $childCount = ($allPublications | Where-Object { $_.parentProject -eq $parent }).Count
            Write-Host "  üìÅ $parent ($childCount deploy(s))"
        }
    }
    
} catch {
    Write-Host "‚ùå Erro ao calcular estat√≠sticas: $($_.Exception.Message)"
}
```

## üîç 6. Testar Deploy Individual

```powershell
Write-Host "üîç Testando obten√ß√£o de deploy individual..."

$testDeployName = "app2-api"
try {
    $individualDeploy = Invoke-RestMethod -Uri "https://localhost:7071/deploy/publications/$testDeployName" -Method GET -Headers $headers
    
    Write-Host "‚úÖ Deploy individual obtido:"
    Write-Host "  Nome: $($individualDeploy.publication.name)"
    Write-Host "  ParentProject: $($individualDeploy.publication.parentProject)"
    Write-Host "  Repository: $($individualDeploy.publication.repository)"
    Write-Host "  FullPath: $($individualDeploy.publication.fullPath)"
    Write-Host "  Exists: $($individualDeploy.publication.exists)"
    
} catch {
    if ($_.Exception.Response.StatusCode -eq 404) {
        Write-Host "‚ö†Ô∏è Deploy $testDeployName n√£o encontrado (esperado se n√£o foi criado)"
    } else {
        Write-Host "‚ùå Erro: $($_.Exception.Message)"
    }
}
```

## üßπ 7. Limpeza (Opcional)

```powershell
Write-Host "üßπ Limpeza opcional dos deploys de teste..."

$cleanup = Read-Host "Deseja remover todos os deploys de teste? (s/N)"
if ($cleanup -eq 's' -or $cleanup -eq 'S') {
    foreach ($deploy in $testDeploys) {
        Write-Host "üóëÔ∏è Removendo: $($deploy.name)"
        
        try {
            $deleteResult = Invoke-RestMethod -Uri "https://localhost:7071/deploy/publications/$($deploy.name)" -Method DELETE -Headers $headers
            Write-Host "  ‚úÖ Removido: $($deleteResult.message)"
        } catch {
            if ($_.Exception.Response.StatusCode -eq 404) {
                Write-Host "  ‚ö†Ô∏è J√° removido ou n√£o encontrado"
            } else {
                Write-Host "  ‚ùå Erro: $($_.Exception.Message)"
            }
        }
    }
} else {
    Write-Host "‚ÑπÔ∏è Deploys de teste mantidos para futuras valida√ß√µes"
}
```

## üìã Resultados Esperados

### ‚úÖ **Estruturas de Teste:**

```json
[
  {
    "name": "app1-standalone",
    "parentProject": null,
    "fullPath": "C:\\temp\\wwwroot\\app1"
  },
  {
    "name": "app2-api", 
    "parentProject": "app2",
    "fullPath": "C:\\temp\\wwwroot\\app2\\api"
  },
  {
    "name": "app2-frontend",
    "parentProject": "app2", 
    "fullPath": "C:\\temp\\wwwroot\\app2\\frontend"
  },
  {
    "name": "microservices-auth",
    "parentProject": "microservices",
    "fullPath": "C:\\temp\\wwwroot\\microservices\\auth"
  },
  {
    "name": "ecommerce-admin-panel",
    "parentProject": "ecommerce",
    "fullPath": "C:\\temp\\wwwroot\\ecommerce\\admin\\panel"
  }
]
```

### üìä **Agrupamento Esperado:**

```
üèóÔ∏è DEPLOYS COM PROJETO PAI:
üìÅ Projeto Pai: app2
  ‚îî‚îÄ‚îÄ app2-api (targetPath: app2/api)
  ‚îî‚îÄ‚îÄ app2-frontend (targetPath: app2/frontend)

üìÅ Projeto Pai: microservices  
  ‚îî‚îÄ‚îÄ microservices-auth (targetPath: microservices/auth)
  ‚îî‚îÄ‚îÄ microservices-payment (targetPath: microservices/payment)

üìÅ Projeto Pai: ecommerce
  ‚îî‚îÄ‚îÄ ecommerce-admin-panel (targetPath: ecommerce/admin/panel)

üè† DEPLOYS NO N√çVEL RAIZ:
üì¶ app1-standalone (parentProject: null)
```

---

**üí° Dica:** Use este script para validar completamente a funcionalidade de detec√ß√£o de projetos pai, incluindo casos complexos com m√∫ltiplos n√≠veis de diret√≥rios.
